import pytest

from unittest.mock import MagicMock

from connect.eaas.core.responses import InteractiveResponse
from connect.eaas.core.enums import ResultType

from connect_malwarebytes.flows.validation_flow import PurchaseDraftValidation
from connect_malwarebytes.flows.flows import AssetsGetter, ProcessingFlow
from connect_malwarebytes.connect.request import OrderingError, RatingPlanError

from tests import test_utils


class TestPurchaseDraftValidation:
    def test_process_successful_purchase_draft_validation(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value='')

        flow.approve_request = MagicMock()
        result = flow.process()

        # Assert
        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_purchase_draft_validation_no_reservation_item(self, connect_client,
                                                                   connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value='')

        # Delete Items
        flow.request_data.items().clear()

        with pytest.raises(RatingPlanError) as exception_info:
            flow.process()
        assert str(
            exception_info.value) == ('Rating plan is not valid. Check that only one rating '
                                      'plan item is selected.')

    def test_process_purchase_draft_validation_more_than_one_reservation_item(self, connect_client,
                                                                              connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value='')

        # Add Reservation Items
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0002",
            "global_id": "PRD-462-646-079-0002",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "new",
                    "events": {
                        "created": {
                            "at": "2023-04-18T16:48:00+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-04-18T16:48:00+00:00",
                        },
                    },
                    "id": "type_item",
                    "title": "Type Item",
                    "description": "Choose if Item is to create new subscription or import "
                                   "subscription",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "New Subscription",
                                "value": "new",
                                "default": True,
                            },
                            {
                                "label": "Import Subscription",
                                "value": "import",
                            },
                        ],
                        "shared": "None",
                    },
                },
            ],
        })

        with pytest.raises(OrderingError) as exception_info:
            flow.process()
        assert str(
            exception_info.value) == 'Only one reservation should be selected.'

    def test_process_draft_validation_email_exists(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        asset = test_utils.mock_asset()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        AssetsGetter.execute = MagicMock(return_value=[asset])
        # Change Email value
        flow.request_data.get_email = MagicMock(return_value='trial003@trial.com')
        ProcessingFlow.check_existing_email = MagicMock(return_value='')

        result = flow.process()

        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_draft_validation_email_wrong_format(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()

        # Change Email value
        flow.request_data.get_email = MagicMock(return_value='trial003')

        result = flow.process()

        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_import_draft_validation_ask_msp_account_id(self, connect_client,
                                                                connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        existing_account = {
            'msp_account_id': '3639633938356633313134323662616561323731643839613936396137313630'}
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value=existing_account)

        # Clear all items and add one reservation to import.
        flow.request_data.items().clear()
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0001",
            "global_id": "PRD-462-646-079-0001",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "paid",
                    "events": {
                        "created": {
                            "at": "2023-06-05T10:08:51+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-06-05T10:08:51+00:00",
                        },
                    },
                    "id": "billing",
                    "title": "Billing",
                    "description": "Billing",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "PAID",
                                "value": "paid",
                                "default": True,
                            },
                            {
                                "label": "TRIAL",
                                "value": "trial",
                            },
                        ],
                        "shared": "view",
                    },
                },
            ],
        })

        flow.approve_request = MagicMock()
        result = flow.process()

        # Assert
        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_successful_import_draft_validation(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        existing_account = {
            'msp_account_id': '3639633938356633313134323662616561323731643839613936396137313630'}
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value=existing_account)

        # Clear all items and add one reservation to import.
        flow.request_data.items().clear()
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0001",
            "global_id": "PRD-462-646-079-0001",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "paid",
                    "events": {
                        "created": {
                            "at": "2023-06-05T10:08:51+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-06-05T10:08:51+00:00",
                        },
                    },
                    "id": "billing",
                    "title": "Billing",
                    "description": "Billing",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "PAID",
                                "value": "paid",
                                "default": True,
                            },
                            {
                                "label": "TRIAL",
                                "value": "trial",
                            },
                        ],
                        "shared": "view",
                    },
                },
            ],
        })
        flow.request_data.params()[3][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'

        flow.approve_request = MagicMock()
        result = flow.process()

        # Assert
        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_import_draft_validation_wrong_msp_account_id(self, connect_client,
                                                                  connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        existing_account = {
            'msp_account_id': '3639633938356633313134323662616561323731643839613936396137313630'}
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value=existing_account)

        # Clear all items and add one reservation to import.
        flow.request_data.items().clear()
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0001",
            "global_id": "PRD-462-646-079-0001",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "paid",
                    "events": {
                        "created": {
                            "at": "2023-06-05T10:08:51+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-06-05T10:08:51+00:00",
                        },
                    },
                    "id": "billing",
                    "title": "Billing",
                    "description": "Billing",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "PAID",
                                "value": "paid",
                                "default": True,
                            },
                            {
                                "label": "TRIAL",
                                "value": "trial",
                            },
                        ],
                        "shared": "view",
                    },
                },
            ],
        })
        flow.request_data.params()[3][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313629'

        result = flow.process()

        # Assert
        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_import_draft_validation_email_exists_in_connect_and_malwarebytes(
            self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        existing_account = {
            'msp_account_id': '3639633938356633313134323662616561323731643839613936396137313630'}
        ProcessingFlow.find_email_in_assets = MagicMock(return_value=True)
        ProcessingFlow.check_existing_email = MagicMock(return_value=existing_account)

        result = flow.process()

        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_import_draft_validation_email_exists_in_connect_not_in_malwarebytes(
            self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        ProcessingFlow.find_email_in_assets = MagicMock(return_value=True)
        ProcessingFlow.check_existing_email = MagicMock(return_value='')

        result = flow.process()

        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_import_draft_validation_account_not_exists(self, connect_client,
                                                                connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value='')

        # Add msp_account_id
        flow.request_data.params()[3][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313627'

        flow.approve_request = MagicMock()
        result = flow.process()

        # Assert
        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_draft_validation_invalid_import_with_trial_item(self, connect_client,
                                                                     connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        existing_account = {
            'msp_account_id': '3639633938356633313134323662616561323731643839613936396137313630'}
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value=existing_account)

        flow.approve_request = MagicMock()
        result = flow.process()

        # Assert
        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_draft_validation_invalid_msp_account_id(self, connect_client,
                                                             connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        existing_account = {
            'msp_account_id': '3639633938356633313134323662616561323731643839613936396137313630'}
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value=existing_account)

        # Clear all items and add one reservation to import.
        flow.request_data.items().clear()
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0001",
            "global_id": "PRD-462-646-079-0001",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "paid",
                    "events": {
                        "created": {
                            "at": "2023-06-05T10:08:51+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-06-05T10:08:51+00:00",
                        },
                    },
                    "id": "billing",
                    "title": "Billing",
                    "description": "Billing",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "PAID",
                                "value": "paid",
                                "default": True,
                            },
                            {
                                "label": "TRIAL",
                                "value": "trial",
                            },
                        ],
                        "shared": "view",
                    },
                },
            ],
        })
        # Add msp_account_id
        flow.request_data.params()[3]['value'] = '363963393835663331313432366'

        result = flow.process()

        # Assert
        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_draft_validation_with_fulfillment_msp_account_id(self, connect_client,
                                                                      connect_logger):
        # Arrange
        request = test_utils.mock_draft_request()
        flow = PurchaseDraftValidation(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        existing_account = {
            'msp_account_id': '3639633938356633313134323662616561323731643839613936396137313630'}
        ProcessingFlow.find_email_in_assets = MagicMock(return_value='')
        ProcessingFlow.check_existing_email = MagicMock(return_value=existing_account)

        # Clear all items and add one reservation to import.
        flow.request_data.items().clear()
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0001",
            "global_id": "PRD-462-646-079-0001",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "paid",
                    "events": {
                        "created": {
                            "at": "2023-06-05T10:08:51+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-06-05T10:08:51+00:00",
                        },
                    },
                    "id": "billing",
                    "title": "Billing",
                    "description": "Billing",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "PAID",
                                "value": "paid",
                                "default": True,
                            },
                            {
                                "label": "TRIAL",
                                "value": "trial",
                            },
                        ],
                        "shared": "view",
                    },
                },
            ],
        })
        # Add msp_account_id
        flow.request_data.params()[4][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'

        result = flow.process()

        # Assert
        assert isinstance(result, InteractiveResponse)
        assert result.status == ResultType.SUCCESS
