import pytest

from unittest.mock import MagicMock, patch

from connect.eaas.core.responses import BackgroundResponse
from connect.eaas.core.enums import ResultType
from malwarebytes.account.domain.exceptions import (
    InvalidAccountToImport, LicenseKeyNotFound, UsersNotFound,
)
from malwarebytes.account.application.services import AccountGetter, OneViewCreator
from malwarebytes.account.infrastructure.exceptions import TrialSubscriptionNotValidException

from connect_malwarebytes.flows.purchase_flow import PurchaseFlow

from tests import test_utils


class TestPurchaseFlow:
    @patch('time.sleep', return_value=None)
    def test_process_successful_purchase(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_successful_purchase_migration_flow(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()

        # Delete Items
        flow.request_data.params()[9]['value'] = {
            'msp_account_id': '6564616336353830656236303235353961643766666561646439326566313466',
            'vendor_id': '3133646330623936323265663735643231303236326537346634313664363430',
        }

        flow.update_parameters = MagicMock()
        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS

    @patch('time.sleep', return_value=None)
    def test_process_successful_purchase_import(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()
        existing_account = {
            'msp_account_id': '3639633938356633313134323662616561323731643839613936396137313630'}
        flow.check_existing_email = MagicMock(return_value=existing_account)

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        # Clear all items and add one reservation to import.
        flow.request_data.items().clear()
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0002",
            "global_id": "PRD-462-646-079-0002",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly Import",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "import",
                    "events": {
                        "created": {
                            "at": "2023-04-18T16:48:00+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-04-18T16:48:00+00:00",
                        },
                    },
                    "id": "type_item",
                    "title": "Type Item",
                    "description": "Choose if Item is to create new subscription or import "
                                   "subscription",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "New Subscription",
                                "value": "new",
                                "default": True,
                            },
                            {
                                "label": "Import Subscription",
                                "value": "import",
                            },
                        ],
                        "shared": "None",
                    },
                },
            ],
        })
        flow.request_data.params()[10][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'

        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS

    def test_process_purchase_no_reservation_item(self, connect_client,
                                                  connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()

        # Delete Items
        flow.request_data.items().clear()

        flow.fail_request = MagicMock()
        result = flow.process()

        assert result.status == ResultType.FAIL

    def test_process_purchase_validation_more_than_one_reservation_item(self, connect_client,
                                                                        connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow._check_existing_email = MagicMock(return_value='')

        # Add Reservation Items
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0002",
            "global_id": "PRD-462-646-079-0002",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "new",
                    "events": {
                        "created": {
                            "at": "2023-04-18T16:48:00+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-04-18T16:48:00+00:00",
                        },
                    },
                    "id": "type_item",
                    "title": "Type Item",
                    "description": "Choose if Item is to create new subscription or import "
                                   "subscription",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "New Subscription",
                                "value": "new",
                                "default": True,
                            },
                            {
                                "label": "Import Subscription",
                                "value": "import",
                            },
                        ],
                        "shared": "None",
                    },
                },
            ],
        })

        flow.fail_request = MagicMock()
        result = flow.process()

        assert result.status == ResultType.FAIL

    def test_process_import_validation_wrong_item_type(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        existing_account = {
            'msp_account_id': '3639633938356633313134323662616561323731643839613936396137313630'}
        flow.check_existing_email = MagicMock(return_value=existing_account)

        # Clear all items and add one reservation to import.
        flow.request_data.items().clear()
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0002",
            "global_id": "PRD-462-646-079-0002",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "",
                    "events": {
                        "created": {
                            "at": "2023-04-18T16:48:00+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-04-18T16:48:00+00:00",
                        },
                    },
                    "id": "type_item",
                    "title": "Type Item",
                    "description": "Choose if Item is to create new subscription or import "
                                   "subscription",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "New Subscription",
                                "value": "new",
                                "default": True,
                            },
                            {
                                "label": "Import Subscription",
                                "value": "import",
                            },
                        ],
                        "shared": "None",
                    },
                },
            ],
        })
        flow.request_data.params()[10][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'

        flow.fail_request = MagicMock()
        result = flow.process()

        assert result.status == ResultType.FAIL

    @patch('time.sleep', return_value=None)
    def test_process_purchase_existing_email(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS

    @patch('time.sleep', return_value=None)
    def test_process_purchase_import_not_exists_email(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        # Clear all items and add one reservation to import.
        flow.request_data.items().clear()
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0002",
            "global_id": "PRD-462-646-079-0002",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly Import",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "import",
                    "events": {
                        "created": {
                            "at": "2023-04-18T16:48:00+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-04-18T16:48:00+00:00",
                        },
                    },
                    "id": "type_item",
                    "title": "Type Item",
                    "description": "Choose if Item is to create new subscription or import "
                                   "subscription",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "New Subscription",
                                "value": "new",
                                "default": True,
                            },
                            {
                                "label": "Import Subscription",
                                "value": "import",
                            },
                        ],
                        "shared": "None",
                    },
                },
            ],
        })
        flow.request_data.params()[10][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'

        with pytest.raises(InvalidAccountToImport) as exception_info:
            flow.process()
        assert str(
            exception_info.value) == ('An account with email test125@catchall.infra.im and MSP '
                                      'account ID 3639633938356633313134323662616561323731643839'
                                      '613936396137313630 does not exist in MalwareBytes')

    @patch('time.sleep', return_value=None)
    def test_process_purchase_import_not_exists_msp_account_id(self, connect_client,
                                                               connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()
        existing_account = {
            'msp_account_id': '5648641657684687453418694564984654864895168436548648654861486468'}
        flow.check_existing_email = MagicMock(return_value=existing_account)

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        # Clear all items and add one reservation to import.
        flow.request_data.items().clear()
        flow.request_data.items().append({
            "id": "PRD_462_646_079_0002",
            "global_id": "PRD-462-646-079-0002",
            "mpn": "BUS-CLOUD",
            "old_quantity": "0",
            "quantity": "1",
            "type": "Licenses",
            "display_name": "OneView Monthly Import",
            "period": "Monthly",
            "item_type": "Reservation",
            "params": [
                {
                    "value": "import",
                    "events": {
                        "created": {
                            "at": "2023-04-18T16:48:00+00:00",
                            "by": {
                                "id": "UR-874-914-133",
                                "name": "Borja Rios",
                            },
                        },
                        "updated": {
                            "at": "2023-04-18T16:48:00+00:00",
                        },
                    },
                    "id": "type_item",
                    "title": "Type Item",
                    "description": "Choose if Item is to create new subscription or import "
                                   "subscription",
                    "type": "choice",
                    "scope": "item",
                    "phase": "configuration",
                    "constraints": {
                        "required": False,
                        "hidden": False,
                        "unique": False,
                        "readonly": False,
                        "choices": [
                            {
                                "label": "New Subscription",
                                "value": "new",
                                "default": True,
                            },
                            {
                                "label": "Import Subscription",
                                "value": "import",
                            },
                        ],
                        "shared": "None",
                    },
                },
            ],
        })
        flow.request_data.params()[10][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'

        with pytest.raises(InvalidAccountToImport) as exception_info:
            flow.process()
        assert str(
            exception_info.value) == ('This account already exists in MalwareBytes with the email '
                                      'test125@catchall.infra.im')

    @patch('time.sleep', return_value=None)
    def test_process_successful_purchase_msp_account_id_already_created(self, connect_client,
                                                                        connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        # Add msp_account_id_fulfillment
        flow.request_data.params()[11][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS

    @patch('time.sleep', return_value=None)
    def test_process_successful_purchase_msp_account_id_license_key_user_id_already_created(
            self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        # Add msp_account_id_fulfillment
        flow.request_data.params()[11][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'
        # Add license_key
        flow.request_data.params()[8]['value'] = 'CB42R-XBGGR-GXFKX-7ZHTP'
        # Add user_id
        flow.request_data.params()[15][
            'value'] = '6436666138363865613861393334623735663530653533393639396330336336'

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS

    @patch('time.sleep', return_value=None)
    def test_process_successful_purchase_msp_account_id_license_key_user_id_site_id_already_created(
            self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        # Add msp_account_id_fulfillment
        flow.request_data.params()[11][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'
        # Add license_key
        flow.request_data.params()[8]['value'] = 'CB42R-XBGGR-GXFKX-7ZHTP'
        # Add user_id
        flow.request_data.params()[15][
            'value'] = '6436666138363865613861393334623735663530653533393639396330336336'
        # Add site_id
        flow.request_data.params()[12][
            'value'] = '30663631386339642D323132332D343737322D623938662D396436313832616530303135'

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS

    @patch('time.sleep', return_value=None)
    def test_process_purchase_license_key_not_obtain(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.oneview_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        flow.update_parameters = MagicMock()

        # Add msp_account_id_fulfillment
        flow.request_data.params()[11][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'

        # Empty license_key
        AccountGetter.get_msp_account = MagicMock(return_value={'users': '', 'license_key': ''})

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        with pytest.raises(LicenseKeyNotFound) as exception_info:
            flow.process()
        assert str(
            exception_info.value) == ('License key for MSP account ID 363963393835663331313432'
                                      '3662616561323731643839613936396137313630 not found.')

    @patch('time.sleep', return_value=None)
    def test_process_purchase_user_id_not_obtain(self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.oneview_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        flow.update_parameters = MagicMock()

        # Add msp_account_id_fulfillment
        flow.request_data.params()[11][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'

        # Empty user_id
        AccountGetter.get_msp_account = MagicMock(
            return_value={'users': '', 'license_key': 'CB42R-XBGGR-GXFKX-7ZHTP'})

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        with pytest.raises(UsersNotFound) as exception_info:
            flow.process()
        assert str(
            exception_info.value) == ('Users for MSP account ID 36396339383566333131343236626165'
                                      '61323731643839613936396137313630 not found.')

    @patch('time.sleep', return_value=None)
    def test_process_successful_purchase_select_ws_server_in_trial_machine(
            self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        # Add msp_account_id_fulfillment
        flow.request_data.params()[11][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'
        # Add license_key
        flow.request_data.params()[8]['value'] = 'CB42R-XBGGR-GXFKX-7ZHTP'
        # Add user_id
        flow.request_data.params()[15][
            'value'] = '6436666138363865613861393334623735663530653533393639396330336336'
        # Add site_id
        flow.request_data.params()[12][
            'value'] = '30663631386339642D323132332D343737322D623938662D396436313832616530303135'
        # Add ws_server to Trial Machine
        flow.request_data.params()[13]['value'] = 'ws-serv'

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS

    @patch('time.sleep', return_value=None)
    def test_process_successful_purchase_select_edr_product_with_ws_server_in_trial_machine(
            self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        # Add msp_account_id_fulfillment
        flow.request_data.params()[11][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'
        # Add license_key
        flow.request_data.params()[8]['value'] = 'CB42R-XBGGR-GXFKX-7ZHTP'
        # Add user_id
        flow.request_data.params()[15][
            'value'] = '6436666138363865613861393334623735663530653533393639396330336336'
        # Add site_id
        flow.request_data.params()[12][
            'value'] = '30663631386339642D323132332D343737322D623938662D396436313832616530303135'
        # Add ws_server to Trial Machine
        flow.request_data.params()[13]['value'] = 'ws-serv'
        # Add ws_server to Trial Product
        flow.request_data.params()[14]['value'] = 'edr'

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS

    @patch('time.sleep', return_value=None)
    def test_process_purchase_exception_to_create_trial_subscription_in_malwarebytes(
            self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.check_existing_email = MagicMock(return_value='')

        # Add msp_account_id_fulfillment
        flow.request_data.params()[11][
            'value'] = '3639633938356633313134323662616561323731643839613936396137313630'
        # Add license_key
        flow.request_data.params()[8]['value'] = 'CB42R-XBGGR-GXFKX-7ZHTP'
        # Add user_id
        flow.request_data.params()[15][
            'value'] = '6436666138363865613861393334623735663530653533393639396330336336'
        # Add site_id
        flow.request_data.params()[12][
            'value'] = '30663631386339642D323132332D343737322D623938662D396436313832616530303135'

        flow.fail_request = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        # Mocking cancellation with an exception
        OneViewCreator.create_trial_subscription = MagicMock(
            side_effect=TrialSubscriptionNotValidException('Some Error'))

        result = flow.process()

        assert result.status == ResultType.SUCCESS

    @patch('time.sleep', return_value=None)
    def test_process_purchase_not_template_id_to_approve_request(
            self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        flow.get_subscription_activation_template = MagicMock(return_value='')
        result = flow.process()

        assert result.status == ResultType.SUCCESS

    @patch('time.sleep', return_value=None)
    def test_process_purchase_not_product_id(
            self, connect_client, connect_logger):
        # Arrange
        request = test_utils.mock_purchase_request()
        flow = PurchaseFlow(request, connect_client, connect_logger, {})
        flow.logger = MagicMock()
        flow.account_repository = MagicMock()
        flow.oneview_repository = MagicMock()

        flow.update_parameters = MagicMock()

        # Set the mock return value for client_id and client_secret
        flow.get_credentials_by_msp_account_id = MagicMock(
            return_value=('mocked_client_id', 'mocked_client_secret'))

        flow.request_data.product_id = MagicMock(return_value='')
        result = flow.process()

        # Assert
        assert isinstance(result, BackgroundResponse)
        assert result.status == ResultType.SUCCESS
