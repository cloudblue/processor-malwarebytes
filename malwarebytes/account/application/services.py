from typing import Optional

from malwarebytes.account.domain.contracts import AccountRepository
from malwarebytes.account.domain.models import AccountId, Account, Contact, Email, MSPAccount
from malwarebytes.account.domain.services import AccountBuilder

from malwarebytes.account.application.exceptions import MissingRequiredAccountException, \
    MissingRequiredContactException


class AccountCreator:
    def __init__(self, repository: AccountRepository):
        self.repository = repository

    def execute(self, account: Account, contact: Contact) -> MSPAccount:
        if isinstance(account, Account) and isinstance(contact, Contact):
            account_to_inject = AccountBuilder.build(account, contact)

        if not account_to_inject["account"]:
            raise MissingRequiredAccountException()

        if not account_to_inject["contact"]:
            raise MissingRequiredContactException()

        return self.repository.update(account_to_inject)


class AccountSuspend:
    def __init__(self, repository: AccountRepository):
        self.repository = repository

    def suspend(self, msp_account_id: AccountId) -> bool:
        return self.repository.suspend(msp_account_id)


class AccountResume:
    def __init__(self, repository: AccountRepository):
        self.repository = repository

    def resume(self, msp_account_id: AccountId) -> bool:
        return self.repository.resume(msp_account_id)


class AccountCancel:
    def __init__(self, repository: AccountRepository):
        self.repository = repository

    def cancel(self, msp_account_id: AccountId) -> bool:
        return self.repository.cancel(msp_account_id)


class AccountGetter:
    def __init__(self, repository: AccountRepository):
        self.repository = repository

    def execute(self, email: Email) -> Optional[MSPAccount]:
        return self.repository.find(email)

    def get_msp_id(self, msp_account_id: AccountId) -> Optional[MSPAccount]:
        return self.repository.find_msp_account_id(msp_account_id)

    def get_license(self, msp_account_id: AccountId):
        return self.repository.get_license(msp_account_id)
