from connect.eaas.core.responses import BackgroundResponse

from connect_malwarebytes.flows.flows import ProcessingFlow
from malwarebytes.account.domain.exceptions import NotExistsMspIdError
from malwarebytes.account.infrastructure.exceptions import MBClientException
from malwarebytes.account.application.services import AccountResume
from malwarebytes.account.domain.models import AccountId
from malwarebytes.account.domain.messages import RESUME_ACCOUNT


class ResumeFlow(ProcessingFlow):
    """
    Resume Subscription
    """

    def process(self) -> BackgroundResponse:
        self.logger.info("Starting Resume process.")

        try:
            self._resume_subscription()
        except MBClientException as err:
            self.logger.warning(str(err))

        return BackgroundResponse.done()

    def _resume_subscription(self):
        """
        Resume Subscription in MalwareBytes.
        """
        msp_account_id = self.request_data.msp_account_id_fulfillment()
        if not msp_account_id:
            raise NotExistsMspIdError("Subscription not contain any MSP Account ID")
        self.logger.info(
            f"Reactivating Subscription in MalwareBytes with MSP Account ID: {msp_account_id}.")
        AccountResume(self.account_repository()).resume(AccountId(msp_account_id))

        self.approve_request(self.request_data.id(), "", RESUME_ACCOUNT.format(msp_account_id))

        self.logger.info(f"Resume request approved to MSP Account ID: {msp_account_id}.")
