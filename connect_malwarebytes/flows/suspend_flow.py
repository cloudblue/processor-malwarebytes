from connect.eaas.core.responses import BackgroundResponse

from connect_malwarebytes.flows.flows import ProcessingFlow
from malwarebytes.account.domain.exceptions import NotExistsMspIdError
from malwarebytes.account.infrastructure.exceptions import MBClientException
from malwarebytes.account.application.services import AccountSuspend
from malwarebytes.account.domain.models import AccountId
from malwarebytes.account.domain.messages import SUSPEND_ACCOUNT


class SuspendFlow(ProcessingFlow):
    """
    Suspend Subscription
    """

    def process(self) -> BackgroundResponse:
        self.logger.info("Starting Suspend process.")

        try:
            self._suspend_subscription()
        except MBClientException as err:
            self.logger.warning(str(err))

        return BackgroundResponse.done()

    def _suspend_subscription(self):
        """
        Suspend Subscription in MalwareBytes.
        """
        msp_account_id = self.request_data.msp_account_id_fulfillment()
        if not msp_account_id:
            raise NotExistsMspIdError("Subscription not contain any MSP Account ID")
        self.logger.info(
            f"Suspending Subscription in MalwareBytes with MSP Account ID: {msp_account_id}.")
        AccountSuspend(self.account_repository()).suspend(AccountId(msp_account_id))

        self.approve_request(self.request_data.id(), "", SUSPEND_ACCOUNT.format(msp_account_id))

        self.logger.info(f"Suspend request approved to MSP Account ID: {msp_account_id}.")
