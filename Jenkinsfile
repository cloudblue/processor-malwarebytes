pipeline {
    agent {
        label 'docker'
    }
    environment {
        SEMANTIC_VERSION=sh(returnStdout: true, script: "git describe --exact-match ${GIT_COMMIT} --abbrev=0 --tags || echo 'v0.0.0-dev'").trim()

        PROJECT_NAME="malwarebytes-oneview-connector_python"
        PROJECT_KEY="connectors-${PROJECT_NAME}"
        PROJECT_VERSION="${SEMANTIC_VERSION}" + "${SEMANTIC_VERSION == 'v0.0.0-dev' ? '.' : '-'}" + "${BUILD_NUMBER}"
    }
    stages {
        stage('Environment Setup') {
            steps {
                sh """
                /opt/rh/rh-python38/root/bin/python3 -m venv venv
                source venv/bin/activate
                pip install --upgrade pip
                pip install pylint poetry --trusted-host pypi.int.zone
                python --version
                """
            }
        }
        stage('Test Execution') {
            steps {
                sh """
                touch .malwarebytes_test.env
                docker-compose run malwarebytes_test
                """
            }
        }
        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool name: 'SonarQubeIntZoneScanner', type: 'hudson.plugins.sonar.SonarRunnerInstallation';
                    withSonarQubeEnv('SonarQubeIntZone') {
                        sh """
                        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
                        ${scannerHome}/bin/sonar-scanner \
                        -Dsonar.project.tags=connectors \
                        -Dsonar.projectVersion=${PROJECT_VERSION} \
                        -Dsonar.projectKey=${PROJECT_KEY} \
                        -Dsonar.sources=connect_malwarebytes/,malwarebytes/ \
                        -Dsonar.tests=tests/ \
                        -Dsonar.python.coverage.reportPaths=coverage.xml \
                        -Dsonar.python.pylint=venv/bin/pylint
                        """
                    }
                }
            }
        }
        stage('Environment Clean') {
            steps {
                sh """
                # cleanup docker stuff.
                docker-compose down --remove-orphans
                """
            }
        }
    }
    post {
        always {
            cleanWs()
        }
    }
}